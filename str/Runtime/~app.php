<?php  function formatString($str){ $countStr=strlen($str); $num=4+(48-$countStr)/3; for($i==0;$i<$num;$i++){ $nbsp.="&emsp;"; } return $str.$nbsp; } function formatTimeToFrame($time){ list($year,$month,$day,$hour,$minute,$second,$frame)=split ("[-: ]",$time); $seconds=mktime($hour,$minute,$second,$month,$day,$year); $frames=$seconds*25+$frame; return $frames; } function frameToFormatTime($frame){ $seconds=explode(".",$frame/25); $time=getdate($seconds[0]); $frames=("0.".$seconds[1])*25; $frames<10?$frames="0".$frames:''; foreach($time as $k=>$v){ if($v<10){ $time[$k]="0".$v; } } return $time['year']."-".$time['mon']."-".$time['mday']." ". $time['hours'].":".$time['minutes'].":".$time['seconds'].":".$frames; } function timeToFrame($time){ $date=explode(":",$time); return $date[0]*3600*25+$date[1]*60*25+$date[2]*25+$date[3]; } function frameToTime($frame){ $hour=intval($frame/3600/25); $min=intval(($frame-$hour*3600*25)/(60*25)); $seconds=intval(($frame-$hour*3600*25-$min*60*25)/25); $frames=$frame-$hour*3600*25-$min*60*25-$seconds*25; $hour<10?$hour="0".$hour:''; $min<10?$min="0".$min:''; $seconds<10?$seconds="0".$seconds:''; $frames<10?$frames="0".$frames:''; return $hour.":".$min.":".$seconds.":".$frames; } function getEndTime($startTime,$duration){ $frames=formatTimeToFrame($startTime)+timeToFrame($duration); return frameToFormatTime($frames); } function hsToSeconds($time){ $hsArray=explode(":", $time); return ($hsArray[0]*60+$hsArray[1]); } function getDurationTime($startTime,$endTime){ return (strtotime($endTime)-strtotime($startTime)); } function saveLog($type,$P_ID){ $data[L_Type]=$type; $data[L_P_ID]=$P_ID; $data[L_DateTime]=date("Y-m-d H:i:s",time()); $data[L_Man]=$_SESSION[M_ID]; $Playlist=M('playlist'); $playlist=$Playlist->where("P_ID=$P_ID")->find(); if($playlist){ $data[L_Detail]=json_encode($playlist); $Log=M('log'); $Log->add($data); }else{ $data[L_Detail]=$P_ID; $Log=M('log'); $Log->add($data); } } function musubstr($str, $start=0, $length, $charset="utf-8", $suffix=true) { if (function_exists("mb_substr")) return mb_substr($str, $start, $length, $charset); elseif (function_exists('iconv_substr')) { return iconv_substr($str, $start, $length, $charset); } $re['utf-8'] = "/[\x01-\x7f]|[\xc2-\xdf][\x80-\xbf]|[\xe0-\xef][\x80-\xbf]{2}|[\xf0-\xff][\x80-\xbf]{3}/"; $re['gb2312'] = "/[\x01-\x7f]|[\xb0-\xf7][\xa0-\xfe]/"; $re['gbk'] = "/[\x01-\x7f]|[\x81-\xfe][\x40-\xfe]/"; $re['big5'] = "/[\x01-\x7f]|[\x81-\xfe]([\x40-\x7e]|\xa1-\xfe])/"; preg_match_all($re[$charset], $str, $match); $slice = join("", array_slice($match[0], $start, $length)); if ($suffix) return $slice . "…"; return $slice; } function formatTime($seconds){ $hour=round($seconds/3600,0); $min=round(($seconds-$hour*3600)/60,0); $sec=$seconds-$hour*3600-$min*60; if($hour>0){ return $hour."小时".$min."分".$sec."秒"; }else{ return $min."分".$sec."秒"; } } function getField($id, $field, $lang, $length) { $arrfield = getFieldStr($lang); $objCate = M("Detail"); $arrCate = $objCate->find($id); $title = $arrCate[$arrfield[$field]]; $title = musubstr($title, 0, $length); return $title; } function toDate($time, $format = 'Y-m-d H:i:s') { if (empty($time)||($time=='-1')) { return ''; } $format = str_replace('#', ':', $format); return date($format, $time); } function Post($curlPost,$url){ $curl = curl_init(); curl_setopt($curl, CURLOPT_URL, $url); curl_setopt($curl, CURLOPT_HEADER, false); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl, CURLOPT_NOBODY, true); curl_setopt($curl, CURLOPT_POST, true); curl_setopt($curl, CURLOPT_POSTFIELDS, $curlPost); $return_str = curl_exec($curl); curl_close($curl); return $return_str; } function my_judge_empty_dir($module) { $tpl_pos=strrpos(__FILE__,"Common"); $dir=substr(__FILE__,0,$tpl_pos)."Tpl\default\\".$module."\\".MODULE_NAME; $handle = opendir($dir); while (($file = readdir($handle)) !== false) { if ($file != "." && $file != "..") { closedir($handle); return false; } } closedir($handle); return true; } function random_verify($number){ $randStr = str_shuffle('1234567890'); $rand = substr($randStr,0,$number); return $rand; } function sendVerify(){ $User=M('User'); $lastSendTime=$User->where("MACAddress='".$_SESSION['mac']."'")->field('SendVerifyTime,SendPhone')->find(); $_SESSION['interval']=time()-intval($lastSendTime['SendVerifyTime']); if(($lastSendTime['SendVerifyTime']!='')&&($_SESSION['interval']<60)&&($_SESSION['tempPhone']==$lastSendTime['SendPhone'])){ return false; }else{ $_SESSION["verifyNumber"]=random_verify(4); $User->where("MACAddress='".$_SESSION['mac']."'")->setField(array('SendVerifyTime','SendPhone'),array(time(),$_SESSION['tempPhone'])); $_SESSION['interval']=0; } } function savePhone($phone,$changeNum){ $User=M('User'); if(!$_SESSION['phone1']){ $User->where("MACAddress='".$_SESSION['mac']."'")->setField('PhoneNo1',$phone); } else if(!$_SESSION['phone2']){ $User->where("MACAddress='".$_SESSION['mac']."'")->setField('PhoneNo2',$phone); } else if(!$_SESSION['phone3']){ $User->where("MACAddress='".$_SESSION['mac']."'")->setField('PhoneNo3',$phone); } else{ $User->where("MACAddress='".$_SESSION['mac']."'")->setField('PhoneNo'.$changeNum,$phone); } } function str_insert($str, $i, $substr) { for($j=0; $j<$i; $j++){ $startstr .= $str[$j]; } for ($j=$i; $j<strlen($str); $j++){ $laststr .= $str[$j]; } $str = ($startstr . $substr . $laststr); return $str; } function QRcode(){ import('@.ORG.QRcode'); import('@.ORG.Image'); $data="http://www.163.com"; $outfile='./Public/images/QRcode/text.png'; $water='./Public/images/sitv_water.png'; $level='M'; $size=9; $margin=1; QRcode::png($data, $outfile, $level, $size,$margin); $Image = new Image(); $Image->water($outfile,$water); } function GetData($val){ $jd = GregorianToJD(1, 1, 1970); $gregorian = JDToGregorian($jd+intval($val)-25569); return $gregorian; } function importExcel($file,$Column=17){ if(!file_exists($file)){ return array("error"=>0,'message'=>'file not found!'); } require_once './Common/Classes/PHPExcel.php'; $objReader = new PHPExcel_Reader_Excel2007(); try{ $PHPReader = $objReader->load($file); }catch(Exception $e){ } if(!isset($PHPReader)) return array("error"=>0,'message'=>'read error!'); $allWorksheets = $PHPReader->getAllSheets(); $i = 0; foreach($allWorksheets as $objWorksheet){ $sheetname=$objWorksheet->getTitle(); $allRow = $objWorksheet->getHighestRow(); $highestColumn = $objWorksheet->getHighestColumn(); $allColumn = PHPExcel_Cell::columnIndexFromString($highestColumn); $allColumn=$Column; $array[$i]["Title"] = $sheetname; $array[$i]["Cols"] = $allColumn; $array[$i]["Rows"] = $allRow; $arr = array(); $isMergeCell = array(); foreach ($objWorksheet->getMergeCells() as $cells) { foreach (PHPExcel_Cell::extractAllCellReferencesInRange($cells) as $cellReference) { $isMergeCell[$cellReference] = true; } } for($currentRow = 1 ;$currentRow<=$allRow;$currentRow++){ $row = array(); for($currentColumn=0;$currentColumn<$allColumn;$currentColumn++){ ; $cell =$objWorksheet->getCellByColumnAndRow($currentColumn, $currentRow); $afCol = PHPExcel_Cell::stringFromColumnIndex($currentColumn+1); $bfCol = PHPExcel_Cell::stringFromColumnIndex($currentColumn-1); $col = PHPExcel_Cell::stringFromColumnIndex($currentColumn); $address = $col.$currentRow; $value = $objWorksheet->getCell($address)->getValue(); if(substr($value,0,1)=='='){ return array("error"=>0,'message'=>'can not use the formula!'); exit; } if($cell->getDataType()==PHPExcel_Cell_DataType::TYPE_NUMERIC){ $cellstyleformat=$cell->getStyle( $cell->getCoordinate() )->getNumberFormat(); $formatcode=$cellstyleformat->getFormatCode(); if (preg_match('/^([$[A-Z]*-[0-9A-F]*])*[dy]/i', $formatcode)) { $value=gmdate("Y-m-d", PHPExcel_Shared_Date::ExcelToPHP($value)); }else{ $value=PHPExcel_Style_NumberFormat::toFormattedString($value,$formatcode); } } if($isMergeCell[$col.$currentRow]&&$isMergeCell[$afCol.$currentRow]&&!empty($value)){ $temp = $value; }elseif($isMergeCell[$col.$currentRow]&&$isMergeCell[$col.($currentRow-1)]&&empty($value)){ $value=$arr[$currentRow-1][$currentColumn]; }elseif($isMergeCell[$col.$currentRow]&&$isMergeCell[$bfCol.$currentRow]&&empty($value)){ $value=$temp; } $row[$currentColumn] = $value; } $arr[$currentRow] = $row; } $array[$i]["Content"] = $arr; $i++; } spl_autoload_register(array('Think','autoload')); unset($objWorksheet); unset($PHPReader); unset($PHPExcel); return array("error"=>1,"data"=>$array); } function getXmlToArray($file){ $res=importExcel($file); $arr_excel=array(); foreach($res['data'][0]['Content'] as $key=>$val){ $res=array_filter($val); if($res){ $arr_excel[$key]=$val; } } return $arr_excel; } function GetRandStr($length){ $str='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; $len=strlen($str)-1; $randstr=''; for($i=0;$i<$length;$i++){ $num=mt_rand(0,$len); $randstr .= $str[$num]; } return $randstr; } function uncdata($xml){ $state = 'out'; $a =str_split($xml); $new_xml = ''; foreach ($a AS$k => $v) { switch ($state ) { case'out': if( '<' == $v ) { $state = $v; }else { $new_xml .= $v; } break; case'<': if( '!' == $v ) { $state = $state . $v; }else { $new_xml .= $state . $v; $state = 'out'; } break; case'<!': if( '[' == $v ) { $state = $state . $v; }else { $new_xml .= $state . $v; $state = 'out'; } break; case'<![': if( 'C' == $v ) { $state = $state . $v; }else { $new_xml .= $state . $v; $state = 'out'; } break; case'<![C': if( 'D' == $v ) { $state = $state . $v; }else { $new_xml .= $state . $v; $state = 'out'; } break; case'<![CD': if( 'A' == $v ) { $state = $state . $v; }else { $new_xml .= $state . $v; $state = 'out'; } break; case'<![CDA': if( 'T' == $v ) { $state = $state . $v; }else { $new_xml .= $state . $v; $state = 'out'; } break; case'<![CDAT': if( 'A' == $v ) { $state = $state . $v; }else { $new_xml .= $state . $v; $state = 'out'; } break; case'<![CDATA': if( '[' == $v ) { $cdata = ''; $state = 'in'; }else { $new_xml .= $state . $v; $state = 'out'; } break; case'in': if( ']' == $v ) { $state = $v; }else { $cdata .= $v; } break; case']': if( ']' == $v ) { $state = $state . $v; }else { $cdata .= $state . $v; $state = 'in'; } break; case']]': if( '>' == $v ) { $new_xml .= str_replace('>','&gt;', str_replace('>','&lt;', str_replace('"','&quot;', str_replace('&','&amp;', $cdata)))); $state = 'out'; } else { $cdata .= $state . $v; $state = 'in'; } break; } } return$new_xml; } return array ( 'app_debug' => false, 'app_domain_deploy' => false, 'app_sub_domain_deploy' => false, 'app_plugin_on' => false, 'app_file_case' => false, 'app_group_depr' => '.', 'app_group_list' => 'Admin,Home', 'app_autoload_reg' => false, 'app_autoload_path' => 'Think.Util.', 'app_config_list' => array ( 0 => 'taglibs', 1 => 'routes', 2 => 'tags', 3 => 'htmls', 4 => 'modules', 5 => 'actions', ), 'cookie_expire' => 3600, 'cookie_domain' => '', 'cookie_path' => '/', 'cookie_prefix' => '', 'default_app' => '@', 'default_group' => 'Home', 'default_module' => 'Index', 'default_action' => 'index', 'default_charset' => 'utf-8', 'default_timezone' => 'PRC', 'default_ajax_return' => 'JSON', 'default_theme' => 'default', 'default_lang' => 'zh-cn', 'db_type' => 'mysqli', 'db_host' => 'localhost', 'db_name' => 'SCBIC', 'db_user' => 'root', 'db_pwd' => 'root', 'db_port' => '3306', 'db_prefix' => 't_', 'db_suffix' => '', 'db_fieldtype_check' => false, 'db_fields_cache' => true, 'db_charset' => 'utf8', 'db_deploy_type' => 0, 'db_rw_separate' => false, 'data_cache_time' => -1, 'data_cache_compress' => false, 'data_cache_check' => false, 'data_cache_type' => 'File', 'data_cache_path' => '../str/Runtime/Temp/', 'data_cache_subdir' => false, 'data_path_level' => 1, 'error_message' => '您浏览的页面暂时发生了错误！请稍后再试～', 'error_page' => '', 'html_cache_on' => false, 'html_cache_time' => 60, 'html_read_type' => 0, 'html_file_suffix' => '.shtml', 'lang_switch_on' => false, 'lang_auto_detect' => true, 'log_exception_record' => true, 'log_record' => true, 'log_file_size' => 2097152, 'log_record_level' => array ( 0 => 'SQL', ), 'page_rollpage' => 8, 'page_listrows' => 20, 'session_auto_start' => true, 'show_run_time' => false, 'show_adv_time' => false, 'show_db_times' => false, 'show_cache_times' => false, 'show_use_mem' => false, 'show_page_trace' => false, 'show_error_msg' => true, 'tmpl_engine_type' => 'Think', 'tmpl_detect_theme' => false, 'tmpl_template_suffix' => '.html', 'tmpl_content_type' => 'text/html', 'tmpl_cachfile_suffix' => '.php', 'tmpl_deny_func_list' => 'echo,exit', 'tmpl_parse_string' => '', 'tmpl_l_delim' => '{', 'tmpl_r_delim' => '}', 'tmpl_var_identify' => 'array', 'tmpl_strip_space' => false, 'tmpl_cache_on' => true, 'tmpl_cache_time' => -1, 'tmpl_action_error' => 'Public:error', 'tmpl_action_success' => 'Public:success', 'tmpl_trace_file' => '../core//Tpl/PageTrace.tpl.php', 'tmpl_exception_file' => '../core//Tpl/ThinkException.tpl.php', 'tmpl_file_depr' => '/', 'taglib_begin' => '<', 'taglib_end' => '>', 'taglib_load' => true, 'taglib_build_in' => 'cx', 'taglib_pre_load' => '', 'tag_nested_level' => 3, 'tag_extend_parse' => '', 'token_on' => true, 'token_name' => '__hash__', 'token_type' => 'md5', 'url_case_insensitive' => false, 'url_router_on' => false, 'url_route_rules' => array ( ), 'url_model' => 1, 'url_pathinfo_model' => 2, 'url_pathinfo_depr' => '/', 'url_html_suffix' => '', 'var_group' => 'g', 'var_module' => 'm', 'var_action' => 'a', 'var_router' => 'r', 'var_page' => 'p', 'var_template' => 't', 'var_language' => 'l', 'var_ajax_submit' => 'ajax', 'var_pathinfo' => 's', 'videoalarm' => 'mysqli://root:111111@10.2.2.10:3306/frp', 'radioalarm' => 'mysqli://root:111111@10.2.1.104:3306/monitor_center', 'get_live_url' => 'http://10.2.2.10:8080/FRP/VedioThirdty.do?method=execute&key=1008920', 'get_video_url' => 'http://10.2.2.10:8080/FRP/VedioThirdty.do?method=execute&key=1008920&isDownload=0', 'wsdlyj' => 'http://10.2.6.235:8010/Portal/WebServices/CusDevWebService.asmx?wsdl', 'wsdl' => 'http://10.2.6.235:8010/Portal/Webservices/ExternalStartService.asmx?wsdl', 'stream_url' => 'http://10.2.1.29/video', 'originalvideofilepath' => 'Z:\\JSJC\\SysRecord\\StreamTS\\', 'originalfmfilepath' => 'Z:\\JSJC\\SysRecord\\Audio\\', 'cutfilepath' => 'D:\\media\\', 'originalvideopath' => 'http://10.2.1.29:9000/JSJC/SysRecord/StreamTS/', 'originalfmpath' => 'http://10.2.1.29:9000/JSJC/SysRecord/Audio/', 'cutvideopath' => 'http://10.2.1.29:8001/media/', 'radiocopypath' => 'C:\\radio\\Uninstall.xml', 'tspath' => 'Z:/', 'warningmsginpath' => 'C:\\SCBIC\\AlartService\\in-xml\\', 'warningmsgoutpath' => 'C:\\SCBIC\\AlartService\\out-xml\\', 'dengjiurl' => 'http://10.2.1.35:8010/Portal/StartInstance.aspx?WorkflowCode=TVSignalException&PageAction=Close', 'db_scbic2' => 'mysqli://root:root@localhost:3306/scbic2', 'user_auth_on' => false, 'user_auth_type' => 1, 'user_auth_key' => 'uid', 'user_auth_model' => 'User', 'rbac_admin' => 'admin', 'admin_auth_key' => 'administrator', 'not_auth_module' => '', 'not_auth_action' => '', 'user_auth_gateway' => 'Admin-Public/login', 'rbac_role_table' => '', 'rbac_user_table' => '', 'rbac_access_table' => '', 'rbac_node_table' => '', ); ?>